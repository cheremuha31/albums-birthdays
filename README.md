# albums-birthdays

Инструменты для подготовки персонального списка альбомов и Telegram‑бот, который напоминает о днях рождения этих релизов.

## Структура проекта

* `album_analyzer/` — десктопное (кроссплатформенное) приложение в виде консольной утилиты. Оно умеет читать архивы со статистикой прослушиваний (например, расширенную статистику Spotify), агрегировать количество минут по альбомам, фильтровать по порогу и, при необходимости, запросить дату релиза на MusicBrainz. Результат сохраняется в JSON, который затем можно отправить боту.
* `bot/` — код Telegram‑бота. После загрузки JSON‑файла бот показывает список ближайших праздников и автоматически присылает уведомления заранее и в сам день рождения альбома.
* `tests/` — небольшие автотесты, проверяющие сбор данных, экспорт и логику расчёта дней рождения.

## Установка зависимостей

Рекомендуется использовать отдельное виртуальное окружение Python 3.11+.

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

## Подготовка данных на ПК

### Вариант 1. Консольная утилита

1. Скачайте архив статистики прослушиваний из своего стримингового сервиса (утилита тестировалась на «Extended streaming history» Spotify: файлы `endsong_*.json`).
2. Запустите утилиту и укажите один или несколько архивов/JSON‑файлов, а также минимальное количество минут прослушивания.

```bash
python -m album_analyzer.cli \
    "~/Downloads/MyData.zip" \
    --min-minutes 120 \
    --output albums.json
```

Основные параметры:

* `--min-minutes` — нижний порог по минутам (по умолчанию 60).
* `--output` — путь к итоговому JSON (по умолчанию `albums.json` в текущей папке).
* `--no-fetch-release-dates` — можно добавить этот флаг, чтобы пропустить запросы к MusicBrainz и оставить даты релиза пустыми.
* `--pause` — задержка между запросами к MusicBrainz (по умолчанию 1.1 секунды, соблюдает требования API). Перед продуктивным использованием задайте корректный `USER_AGENT` в `album_analyzer/release_date.py`.

### Вариант 2. Локальное веб-приложение

Если хочется обойтись без терминала, запустите локальное веб-приложение:

```bash
python -m album_analyzer.webapp
```

После запуска откройте [http://127.0.0.1:5000](http://127.0.0.1:5000) в браузере. Загрузите архивы статистики, задайте минимальное количество минут и при необходимости включите запрос дат релиза на MusicBrainz. Приложение работает локально и сразу вернёт готовый файл `albums.json` без необходимости оплачивать хостинг.

Файл `albums.json` содержит массив альбомов со всеми необходимыми полями (`album`, `artist`, `minutes_listened`, `release_date`, список треков и т.д.). Именно этот файл нужен Telegram‑боту.

### Сборка веб-приложения в исполняемый файл

Чтобы делиться приложением с пользователями, у которых не установлен Python, можно собрать автономный `.exe` (или бинарь для своей ОС) через [PyInstaller](https://pyinstaller.org/). В репозитории добавлены вспомогательные скрипты:

1. Установите PyInstaller — он не входит в основные зависимости проекта. Для варианта со встроенным окном дополнительно нужен `pywebview`.

    ```bash
    pip install pyinstaller
    pip install pywebview  # только если нужен режим desktop
    ```

2. Запустите сборку из корня репозитория. По умолчанию формируется браузерная версия, которая разворачивает Flask и открывает страницу во внешнем браузере. Для режима `desktop` используется `run_desktop.py`, который запускает тот же Flask, но отображает интерфейс во встроенном окне (через pywebview).

    ```bash
    python build_exe.py                 # dist/albums-json-web(.exe)
    python build_exe.py --mode desktop  # dist/albums-json-desktop(.exe)
    ```

    Флаги `--name` и `--console` работают в обоих режимах: можно переименовать исполняемый файл (`--name my-generator`) или оставить консоль (`--console`). Аналогичные режимы доступны без сборки через `python run_webapp.py` (браузер) и `python run_desktop.py` (встроенное окно).

## Запуск Telegram‑бота

1. Создайте бота через [@BotFather](https://t.me/BotFather) и получите токен.
2. Экспортируйте переменную окружения `TELEGRAM_BOT_TOKEN`.

```bash
export TELEGRAM_BOT_TOKEN=123456789:ABC...
```

3. Запустите бота:

```bash
python -m bot.main
```

После запуска бот принимает команды:

* `/start` и `/help` — краткая инструкция.
* Загрузка JSON‑файла из утилиты — бот сохранит данные и покажет статистику.
* `/upcoming 30` — посмотреть ближайшие события (по умолчанию 30 дней) и переключаться между ними через встроенные кнопки.

Фоновая задача раз в сутки проверяет, нет ли альбомов с днём рождения сегодня, завтра или через неделю, и отправляет уведомления в личный чат. Повторы исключаются, бот запоминает, что уже уведомлял конкретного пользователя про конкретный альбом в заданный день.

Все пользовательские данные хранятся локально в каталоге `bot_data/`.

## Тестирование

```bash
pytest
```

## Ограничения и доработки

* Архивы должны содержать название альбома и исполнителя в каждом событии прослушивания (например, `master_metadata_album_album_name`). Если сервис предоставляет другую структуру, адаптируйте функцию `_extract_album_entry` в `album_analyzer/parser.py`.
* Для корректной работы MusicBrainz требуется сетевое соединение и корректный `User-Agent`. Если API не находит релиз, дата останется пустой, бот пропустит такой альбом.
* В проекте нет GUI, но утилита и бот одинаково работают на Windows и Linux (через Python).
