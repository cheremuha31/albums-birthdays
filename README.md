# albums-birthdays

Инструменты для подготовки персонального списка альбомов и Telegram‑бот, который напоминает о днях рождения этих релизов.

## Структура проекта

* `album_analyzer/` — десктопное (кроссплатформенное) приложение в виде консольной утилиты. Оно умеет читать архивы со статистикой прослушиваний (например, расширенную статистику Spotify), агрегировать количество минут по альбомам, фильтровать по порогу и, при необходимости, запросить дату релиза на MusicBrainz. Результат сохраняется в JSON, который затем можно отправить боту.
* `bot/` — код Telegram‑бота. После загрузки JSON‑файла бот показывает список ближайших праздников и автоматически присылает уведомления заранее и в сам день рождения альбома.
* `tests/` — небольшие автотесты, проверяющие сбор данных, экспорт и логику расчёта дней рождения.

## Установка зависимостей

Рекомендуется использовать отдельное виртуальное окружение Python 3.11+.

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

## Подготовка данных на ПК

1. Скачайте архив статистики прослушиваний из своего стримингового сервиса (утилита тестировалась на «Extended streaming history» Spotify: файлы `endsong_*.json`).
2. Запустите утилиту и укажите один или несколько архивов/JSON‑файлов, а также минимальное количество минут прослушивания.

```bash
python -m album_analyzer.cli \
    "~/Downloads/MyData.zip" \
    --min-minutes 120 \
    --output albums.json
```

Основные параметры:

* `--min-minutes` — нижний порог по минутам (по умолчанию 60).
* `--output` — путь к итоговому JSON (по умолчанию `albums.json` в текущей папке).
* `--no-fetch-release-dates` — можно добавить этот флаг, чтобы пропустить запросы к MusicBrainz и оставить даты релиза пустыми.
* `--pause` — задержка между запросами к MusicBrainz (по умолчанию 1.1 секунды, соблюдает требования API). Перед продуктивным использованием задайте корректный `USER_AGENT` в `album_analyzer/release_date.py`.

Файл `albums.json` содержит массив альбомов со всеми необходимыми полями (`album`, `artist`, `minutes_listened`, `release_date`, список треков и т.д.). Именно этот файл нужен Telegram‑боту.

## Запуск Telegram‑бота

1. Создайте бота через [@BotFather](https://t.me/BotFather) и получите токен.
2. Экспортируйте переменную окружения `TELEGRAM_BOT_TOKEN`.

```bash
export TELEGRAM_BOT_TOKEN=123456789:ABC...
```

3. Запустите бота:

```bash
python -m bot.main
```

После запуска бот принимает команды:

* `/start` и `/help` — краткая инструкция.
* Загрузка JSON‑файла из утилиты — бот сохранит данные и покажет статистику.
* `/upcoming 30` — посмотреть ближайшие события (по умолчанию 30 дней).

Фоновая задача раз в сутки проверяет, нет ли альбомов с днём рождения сегодня, завтра или через неделю, и отправляет уведомления в личный чат. Повторы исключаются, бот запоминает, что уже уведомлял конкретного пользователя про конкретный альбом в заданный день.

Все пользовательские данные хранятся локально в каталоге `bot_data/`.

## Тестирование

```bash
pytest
```

## Ограничения и доработки

* Архивы должны содержать название альбома и исполнителя в каждом событии прослушивания (например, `master_metadata_album_album_name`). Если сервис предоставляет другую структуру, адаптируйте функцию `_extract_album_entry` в `album_analyzer/parser.py`.
* Для корректной работы MusicBrainz требуется сетевое соединение и корректный `User-Agent`. Если API не находит релиз, дата останется пустой, бот пропустит такой альбом.
* В проекте нет GUI, но утилита и бот одинаково работают на Windows и Linux (через Python).
